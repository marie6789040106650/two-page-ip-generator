# 工作区2: API集成和内容生成 - 需求规格

## 项目背景

### 原项目架构
- **API路由**: `/api/generate` - 单一的内容生成接口
- **AI集成**: 直接在API路由中调用AI服务
- **内容格式**: 返回HTML格式的内容
- **部署方式**: 与前端页面在同一个Next.js项目中

### 重构目标
将原项目的API和内容生成逻辑分离为独立的工作区，专注于**API服务和内容生成**，同时保持与原项目的功能兼容性。

## 需求概述

创建独立的API服务工作区，负责接收表单数据、调用AI服务生成内容，并返回标准化的Markdown格式内容给其他工作区使用。

## 功能需求

### 需求1: 原项目API功能复用

**用户故事**: 作为工作区1，我需要调用内容生成API，以便为用户生成店铺IP方案

#### 验收标准
1. WHEN 工作区1发送POST请求到 `/api/generate-content` THEN 系统应接收并验证表单数据
2. WHEN 接收到有效的表单数据 THEN 系统应调用AI服务生成内容
3. WHEN AI服务返回内容 THEN 系统应将内容转换为Markdown格式
4. WHEN 内容生成完成 THEN 系统应返回标准化的JSON响应

### 需求2: 内容格式标准化

**用户故事**: 作为工作区3，我需要接收标准化的Markdown内容，以便进行HTML渲染

#### 验收标准
1. WHEN API返回内容时 THEN 内容格式必须是标准Markdown
2. WHEN 返回Markdown内容时 THEN 必须包含完整的元数据信息
3. WHEN 内容包含图片时 THEN 图片链接必须是可访问的URL
4. WHEN 内容包含表格时 THEN 表格必须使用标准Markdown表格语法

### 需求3: AI服务集成优化

**用户故事**: 作为系统管理员，我希望AI服务调用稳定可靠，有完善的错误处理机制

#### 验收标准
1. WHEN AI服务不可用时 THEN 系统应返回备用内容而不是错误
2. WHEN AI服务响应超时时 THEN 系统应在10秒后返回超时错误
3. WHEN AI服务返回无效内容时 THEN 系统应使用模板生成备用内容
4. WHEN 连续调用失败时 THEN 系统应启用熔断机制

### 需求4: 缓存机制

**用户故事**: 作为用户，我希望相同的表单数据能够快速返回结果，提高响应速度

#### 验收标准
1. WHEN 接收到表单数据时 THEN 系统应检查缓存中是否有相同数据的结果
2. WHEN 缓存命中时 THEN 系统应直接返回缓存内容，响应时间<1秒
3. WHEN 缓存未命中时 THEN 系统应生成新内容并存储到缓存
4. WHEN 缓存内容过期时 THEN 系统应自动清理过期数据

### 需求5: Banner图片生成

**用户故事**: 作为用户，我希望生成的方案包含相关的Banner图片，使内容更加丰富

#### 验收标准
1. WHEN 生成文本内容时 THEN 系统应同时生成相关的Banner图片
2. WHEN Banner生成成功时 THEN 图片URL应包含在API响应中
3. WHEN Banner生成失败时 THEN 系统应使用默认图片或跳过图片
4. WHEN 返回图片URL时 THEN URL必须是可直接访问的

## 技术需求

### 需求6: API接口标准化

**用户故事**: 作为其他工作区，我需要调用标准化的API接口，以便进行系统集成

#### 验收标准
1. WHEN 调用API时 THEN 所有接口应遵循RESTful设计原则
2. WHEN API返回数据时 THEN 响应格式应统一使用标准JSON结构
3. WHEN API发生错误时 THEN 错误响应应包含错误码和详细信息
4. WHEN API版本更新时 THEN 应保持向后兼容性

### 需求7: 健康检查和监控

**用户故事**: 作为运维人员，我需要监控API服务的健康状态，以便及时发现和解决问题

#### 验收标准
1. WHEN 访问 `/api/health` 时 THEN 系统应返回服务健康状态
2. WHEN 服务正常时 THEN 健康检查应返回200状态码和详细信息
3. WHEN 依赖服务异常时 THEN 健康检查应反映异常状态
4. WHEN 系统负载过高时 THEN 健康检查应包含性能指标

### 需求8: 性能要求

**用户故事**: 作为用户，我希望API响应速度快，不影响使用体验

#### 验收标准
1. WHEN 调用内容生成API时 THEN 响应时间应在10秒内
2. WHEN 缓存命中时 THEN 响应时间应在1秒内
3. WHEN 并发请求时 THEN 系统应支持至少100个并发请求
4. WHEN 系统负载高时 THEN 应启用请求限流机制

## 与原项目的主要区别

### 架构变化
- **原项目**: API路由嵌入在主项目的 `/api/generate` 中
- **新架构**: 独立的API服务工作区，运行在端口3002

### 内容格式变化
- **原项目**: 返回HTML格式内容，直接用于页面展示
- **新格式**: 返回Markdown格式内容，供工作区3进行渲染

### 服务独立性
- **原项目**: 与前端页面紧耦合，共享数据库和配置
- **新架构**: 完全独立的微服务，有自己的缓存和配置

### AI服务集成
- **原项目**: 简单的AI API调用，错误处理基础
- **新功能**: 完善的AI服务集成，包含重试、熔断、备用方案

## API接口规范

### POST /api/generate-content

**请求格式**:
```json
{
  "storeName": "店铺名称",
  "storeCategory": "店铺类别", 
  "storeLocation": "店铺位置",
  "businessDuration": "经营时长",
  "storeFeatures": "店铺特色",
  "ownerName": "店主姓名",
  "ownerFeatures": "店主特色"
}
```

**响应格式**:
```json
{
  "success": true,
  "content": "# 店铺IP方案\n\n## 概况\n...",
  "metadata": {
    "wordCount": 1200,
    "generatedAt": "2024-01-01T12:00:00.000Z",
    "template": "restaurant-template",
    "qualityScore": 85
  },
  "bannerUrl": "https://example.com/banner.jpg"
}
```

### GET /api/health

**响应格式**:
```json
{
  "status": "healthy",
  "timestamp": "2024-01-01T12:00:00.000Z",
  "services": {
    "ai": "active",
    "cache": "active",
    "database": "active"
  }
}
```

## 开发优先级

### P0 (必须实现)
- 基础的内容生成API
- 与工作区1的数据接口对接
- Markdown格式输出

### P1 (重要功能)
- 缓存机制
- 错误处理和重试
- 健康检查接口

### P2 (增强功能)
- Banner图片生成
- 性能监控
- 请求限流

## 验收测试场景

### 场景1: 基础API调用
1. 工作区1发送完整的表单数据
2. API接收并验证数据
3. 调用AI服务生成内容
4. 返回Markdown格式的响应

### 场景2: 缓存功能
1. 发送相同的表单数据两次
2. 第一次调用生成新内容
3. 第二次调用返回缓存内容
4. 验证响应时间明显缩短

### 场景3: 错误处理
1. 发送无效的表单数据
2. 验证API返回适当的错误信息
3. 模拟AI服务不可用
4. 验证返回备用内容

## 参考资料

### 原项目文件参考
- `app/api/generate/route.ts` - 原API路由实现
- AI服务调用的相关代码
- 内容生成的模板和逻辑

### 相关文档
- 工作区1的表单数据格式
- 工作区3的Markdown接收规范
- AI服务的API文档